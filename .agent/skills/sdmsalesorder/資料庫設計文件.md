# SDM 銷售訂單系統 - 資料庫設計文件

## 文件資訊
- **專案名稱**: SDM Sale Order System
- **資料庫類型**: Oracle Database 11g
- **文件建立日期**: 2026-01-26
- **適用對象**: 資料庫管理員、開發人員

---

## 目錄
1. [資料庫概述](#1-資料庫概述)
2. [資料表設計](#2-資料表設計)
3. [索引設計](#3-索引設計)
4. [存儲過程](#4-存儲過程)
5. [視圖設計](#5-視圖設計)
6. [觸發器](#6-觸發器)
7. [資料字典](#7-資料字典)

---

## 1. 資料庫概述

### 1.1 資料庫連接資訊

```properties
# 測試環境
spring.datasource.url=jdbc:oracle:thin:@//60.249.24.174:1521/db11g.ginko.com.tw
spring.datasource.username=prg
spring.datasource.driver-class-name=oracle.jdbc.driver.OracleDriver
```

### 1.2 Schema結構

系統使用的主要Schema:
- **PRG**: 程式開發Schema，包含所有業務表和存儲過程

### 1.3 命名規範

#### 1.3.1 表名規範
- 前綴: `SDM_SO_` (SDM Sale Order)
- 格式: 大寫字母 + 底線分隔
- 範例: `SDM_SO_MEMBER`, `SDM_SO_SHOPPING_CART`

#### 1.3.2 欄位名規範
- 格式: 大寫字母 + 底線分隔
- 主鍵: 表名去前綴 + `_ID`
- 外鍵: 參照表名去前綴 + `_ID`
- 範例: `SO_MEMBER_ID`, `SO_ITEM_ID`

#### 1.3.3 索引名規範
- 主鍵索引: `PK_` + 表名
- 外鍵索引: `FK_` + 表名 + `_` + 序號
- 一般索引: `IDX_` + 表名 + `_` + 欄位名

---

## 2. 資料表設計

### 2.1 會員相關表

#### 2.1.1 SDM_SO_MEMBER (會員表)

**表說明**: 儲存系統會員的基本資訊

```sql
CREATE TABLE SDM_SO_MEMBER (
    SO_MEMBER_ID        NUMBER(10)      NOT NULL,
    SO_MEMBER_NO        VARCHAR2(20)    NOT NULL,
    SO_MEMBER_NAME      VARCHAR2(100)   NOT NULL,
    PASSWORD            VARCHAR2(100)   NOT NULL,
    E_MAIL              VARCHAR2(100),
    TEL_NO              VARCHAR2(20),
    MOBILE_PHONE_NO     VARCHAR2(20),
    FAX_NO              VARCHAR2(20),
    SO_STORE_ID         NUMBER(10),
    DEFAULT_LANGUAGE_ID NUMBER(10),
    DEFAULT_DATE_TYPE   VARCHAR2(10),
    SO_MEMBER_SOURCE_KIND VARCHAR2(20),
    SO_MEMBER_SOURCE_PK NUMBER(10),
    SO_MEMBER_STATUS    VARCHAR2(10)    NOT NULL,
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    LOCK_TIME           DATE,
    CONSTRAINT PK_SDM_SO_MEMBER PRIMARY KEY (SO_MEMBER_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SO_MEMBER_ID | NUMBER | 10 | Y | 會員ID (主鍵) |
| SO_MEMBER_NO | VARCHAR2 | 20 | Y | 會員編號 (唯一) |
| SO_MEMBER_NAME | VARCHAR2 | 100 | Y | 會員名稱 |
| PASSWORD | VARCHAR2 | 100 | Y | 密碼 (加密) |
| E_MAIL | VARCHAR2 | 100 | N | 電子郵件 |
| TEL_NO | VARCHAR2 | 20 | N | 電話號碼 |
| MOBILE_PHONE_NO | VARCHAR2 | 20 | N | 手機號碼 |
| FAX_NO | VARCHAR2 | 20 | N | 傳真號碼 |
| SO_STORE_ID | NUMBER | 10 | N | 商店ID |
| DEFAULT_LANGUAGE_ID | NUMBER | 10 | N | 預設語言ID |
| DEFAULT_DATE_TYPE | VARCHAR2 | 10 | N | 預設日期格式 |
| SO_MEMBER_SOURCE_KIND | VARCHAR2 | 20 | N | 會員來源類型 |
| SO_MEMBER_SOURCE_PK | NUMBER | 10 | N | 會員來源主鍵 |
| SO_MEMBER_STATUS | VARCHAR2 | 10 | Y | 會員狀態 (A:啟用, I:停用) |
| ENTRY_DATE | DATE | - | Y | 建立日期 |
| ENTRY_ID | VARCHAR2 | 20 | Y | 建立人員 |
| TR_DATE | DATE | - | N | 異動日期 |
| TR_ID | VARCHAR2 | 20 | N | 異動人員 |
| LOCK_TIME | DATE | - | N | 鎖定時間 |

**索引**:
```sql
-- 主鍵索引
CREATE UNIQUE INDEX PK_SDM_SO_MEMBER ON SDM_SO_MEMBER(SO_MEMBER_ID);

-- 唯一索引
CREATE UNIQUE INDEX UK_SDM_SO_MEMBER_NO ON SDM_SO_MEMBER(SO_MEMBER_NO);

-- 一般索引
CREATE INDEX IDX_SDM_SO_MEMBER_STATUS ON SDM_SO_MEMBER(SO_MEMBER_STATUS);
CREATE INDEX IDX_SDM_SO_MEMBER_STORE ON SDM_SO_MEMBER(SO_STORE_ID);
```

**約束**:
```sql
-- 檢查約束
ALTER TABLE SDM_SO_MEMBER ADD CONSTRAINT CK_MEMBER_STATUS
    CHECK (SO_MEMBER_STATUS IN ('A', 'I'));
```

---

### 2.2 購物車相關表

#### 2.2.1 SDM_SO_SHOPPING_CART (購物車表)

**表說明**: 儲存會員的購物車資訊

```sql
CREATE TABLE SDM_SO_SHOPPING_CART (
    SO_SHOPPING_CART_ID NUMBER(10)      NOT NULL,
    SO_MEMBER_ID        NUMBER(10)      NOT NULL,
    SO_ITEM_ID          NUMBER(10)      NOT NULL,
    PART_ID             NUMBER(10)      NOT NULL,
    QTY                 NUMBER(10,2)    NOT NULL,
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    CONSTRAINT PK_SDM_SO_SHOPPING_CART PRIMARY KEY (SO_SHOPPING_CART_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SO_SHOPPING_CART_ID | NUMBER | 10 | Y | 購物車ID (主鍵) |
| SO_MEMBER_ID | NUMBER | 10 | Y | 會員ID (外鍵) |
| SO_ITEM_ID | NUMBER | 10 | Y | 產品ID |
| PART_ID | NUMBER | 10 | Y | 規格ID |
| QTY | NUMBER | 10,2 | Y | 數量 |
| ENTRY_DATE | DATE | - | Y | 建立日期 |
| ENTRY_ID | VARCHAR2 | 20 | Y | 建立人員 |
| TR_DATE | DATE | - | N | 異動日期 |
| TR_ID | VARCHAR2 | 20 | N | 異動人員 |

**索引**:
```sql
-- 主鍵索引
CREATE UNIQUE INDEX PK_SDM_SO_SHOPPING_CART
    ON SDM_SO_SHOPPING_CART(SO_SHOPPING_CART_ID);

-- 外鍵索引
CREATE INDEX FK_SHOPPING_CART_MEMBER
    ON SDM_SO_SHOPPING_CART(SO_MEMBER_ID);

-- 複合索引
CREATE INDEX IDX_CART_MEMBER_ITEM
    ON SDM_SO_SHOPPING_CART(SO_MEMBER_ID, SO_ITEM_ID, PART_ID);
```

**外鍵約束**:
```sql
ALTER TABLE SDM_SO_SHOPPING_CART
    ADD CONSTRAINT FK_CART_MEMBER
    FOREIGN KEY (SO_MEMBER_ID)
    REFERENCES SDM_SO_MEMBER(SO_MEMBER_ID);
```

---

### 2.3 訂單相關表

#### 2.3.1 SDM_SO_ORDER_HEAD (訂單表頭)

**表說明**: 儲存訂單的基本資訊

```sql
CREATE TABLE SDM_SO_ORDER_HEAD (
    SO_ORDER_HEAD_ID    NUMBER(10)      NOT NULL,
    SO_MEMBER_ID        NUMBER(10)      NOT NULL,
    ORDER_NO            VARCHAR2(30)    NOT NULL,
    ORDER_DATE          DATE            NOT NULL,
    ORDER_STATUS        VARCHAR2(10)    NOT NULL,
    TOTAL_QTY           NUMBER(10,2),
    TOTAL_AMOUNT        NUMBER(15,2),
    REMARK              VARCHAR2(500),
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    CONSTRAINT PK_SDM_SO_ORDER_HEAD PRIMARY KEY (SO_ORDER_HEAD_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SO_ORDER_HEAD_ID | NUMBER | 10 | Y | 訂單ID (主鍵) |
| SO_MEMBER_ID | NUMBER | 10 | Y | 會員ID (外鍵) |
| ORDER_NO | VARCHAR2 | 30 | Y | 訂單號碼 |
| ORDER_DATE | DATE | - | Y | 訂單日期 |
| ORDER_STATUS | VARCHAR2 | 10 | Y | 訂單狀態 |
| TOTAL_QTY | NUMBER | 10,2 | N | 總數量 |
| TOTAL_AMOUNT | NUMBER | 15,2 | N | 總金額 |
| REMARK | VARCHAR2 | 500 | N | 備註 |
| ENTRY_DATE | DATE | - | Y | 建立日期 |
| ENTRY_ID | VARCHAR2 | 20 | Y | 建立人員 |
| TR_DATE | DATE | - | N | 異動日期 |
| TR_ID | VARCHAR2 | 20 | N | 異動人員 |

**訂單狀態代碼**:
- `NEW`: 新建
- `CONFIRMED`: 已確認
- `PROCESSING`: 處理中
- `SHIPPED`: 已出貨
- `COMPLETED`: 已完成
- `CANCELLED`: 已取消

**索引**:
```sql
-- 主鍵索引
CREATE UNIQUE INDEX PK_SDM_SO_ORDER_HEAD
    ON SDM_SO_ORDER_HEAD(SO_ORDER_HEAD_ID);

-- 唯一索引
CREATE UNIQUE INDEX UK_ORDER_NO
    ON SDM_SO_ORDER_HEAD(ORDER_NO);

-- 外鍵索引
CREATE INDEX FK_ORDER_MEMBER
    ON SDM_SO_ORDER_HEAD(SO_MEMBER_ID);

-- 一般索引
CREATE INDEX IDX_ORDER_DATE
    ON SDM_SO_ORDER_HEAD(ORDER_DATE);
CREATE INDEX IDX_ORDER_STATUS
    ON SDM_SO_ORDER_HEAD(ORDER_STATUS);
```

**約束**:
```sql
-- 外鍵約束
ALTER TABLE SDM_SO_ORDER_HEAD
    ADD CONSTRAINT FK_ORDER_MEMBER
    FOREIGN KEY (SO_MEMBER_ID)
    REFERENCES SDM_SO_MEMBER(SO_MEMBER_ID);

-- 檢查約束
ALTER TABLE SDM_SO_ORDER_HEAD ADD CONSTRAINT CK_ORDER_STATUS
    CHECK (ORDER_STATUS IN ('NEW', 'CONFIRMED', 'PROCESSING',
                            'SHIPPED', 'COMPLETED', 'CANCELLED'));
```

---

#### 2.3.2 SDM_SO_ORDER_DETAIL (訂單明細)

**表說明**: 儲存訂單的明細資訊

```sql
CREATE TABLE SDM_SO_ORDER_DETAIL (
    SO_ORDER_DETAIL_ID  NUMBER(10)      NOT NULL,
    SO_ORDER_HEAD_ID    NUMBER(10)      NOT NULL,
    LINE_NO             NUMBER(5)       NOT NULL,
    SO_ITEM_ID          NUMBER(10)      NOT NULL,
    PART_ID             NUMBER(10)      NOT NULL,
    QTY                 NUMBER(10,2)    NOT NULL,
    UNIT_PRICE          NUMBER(15,2)    NOT NULL,
    AMOUNT              NUMBER(15,2)    NOT NULL,
    REMARK              VARCHAR2(500),
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    CONSTRAINT PK_SDM_SO_ORDER_DETAIL PRIMARY KEY (SO_ORDER_DETAIL_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SO_ORDER_DETAIL_ID | NUMBER | 10 | Y | 訂單明細ID (主鍵) |
| SO_ORDER_HEAD_ID | NUMBER | 10 | Y | 訂單ID (外鍵) |
| LINE_NO | NUMBER | 5 | Y | 行號 |
| SO_ITEM_ID | NUMBER | 10 | Y | 產品ID |
| PART_ID | NUMBER | 10 | Y | 規格ID |
| QTY | NUMBER | 10,2 | Y | 數量 |
| UNIT_PRICE | NUMBER | 15,2 | Y | 單價 |
| AMOUNT | NUMBER | 15,2 | Y | 金額 |
| REMARK | VARCHAR2 | 500 | N | 備註 |
| ENTRY_DATE | DATE | - | Y | 建立日期 |
| ENTRY_ID | VARCHAR2 | 20 | Y | 建立人員 |
| TR_DATE | DATE | - | N | 異動日期 |
| TR_ID | VARCHAR2 | 20 | N | 異動人員 |

**索引**:
```sql
-- 主鍵索引
CREATE UNIQUE INDEX PK_SDM_SO_ORDER_DETAIL
    ON SDM_SO_ORDER_DETAIL(SO_ORDER_DETAIL_ID);

-- 外鍵索引
CREATE INDEX FK_DETAIL_ORDER
    ON SDM_SO_ORDER_DETAIL(SO_ORDER_HEAD_ID);

-- 複合索引
CREATE INDEX IDX_DETAIL_ORDER_LINE
    ON SDM_SO_ORDER_DETAIL(SO_ORDER_HEAD_ID, LINE_NO);
```

**約束**:
```sql
-- 外鍵約束
ALTER TABLE SDM_SO_ORDER_DETAIL
    ADD CONSTRAINT FK_DETAIL_ORDER
    FOREIGN KEY (SO_ORDER_HEAD_ID)
    REFERENCES SDM_SO_ORDER_HEAD(SO_ORDER_HEAD_ID);
```

---

### 2.4 公告相關表

#### 2.4.1 SDM_SHIP_ANNOUNCE (公告表)

**表說明**: 儲存系統公告資訊

```sql
CREATE TABLE SDM_SHIP_ANNOUNCE (
    SHIP_ANNOUNCE_ID    NUMBER(10)      NOT NULL,
    ANNOUNCE_CONTENT    CLOB            NOT NULL,
    START_DATE          DATE            NOT NULL,
    END_DATE            DATE            NOT NULL,
    ANNOUNCE_STATUS     VARCHAR2(10)    NOT NULL,
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    CONSTRAINT PK_SDM_SHIP_ANNOUNCE PRIMARY KEY (SHIP_ANNOUNCE_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SHIP_ANNOUNCE_ID | NUMBER | 10 | Y | 公告ID (主鍵) |
| ANNOUNCE_CONTENT | CLOB | - | Y | 公告內容 |
| START_DATE | DATE | - | Y | 開始日期 |
| END_DATE | DATE | - | Y | 結束日期 |
| ANNOUNCE_STATUS | VARCHAR2 | 10 | Y | 公告狀態 (A:啟用, I:停用) |
| ENTRY_DATE | DATE | - | Y | 建立日期 |
| ENTRY_ID | VARCHAR2 | 20 | Y | 建立人員 |
| TR_DATE | DATE | - | N | 異動日期 |
| TR_ID | VARCHAR2 | 20 | N | 異動人員 |

**索引**:
```sql
-- 主鍵索引
CREATE UNIQUE INDEX PK_SDM_SHIP_ANNOUNCE
    ON SDM_SHIP_ANNOUNCE(SHIP_ANNOUNCE_ID);

-- 一般索引
CREATE INDEX IDX_ANNOUNCE_DATE
    ON SDM_SHIP_ANNOUNCE(START_DATE, END_DATE);
CREATE INDEX IDX_ANNOUNCE_STATUS
    ON SDM_SHIP_ANNOUNCE(ANNOUNCE_STATUS);
```

---

#### 2.4.2 SDM_SHIP_ANNOUNCE_CUSTOMER (公告會員關聯表)

**表說明**: 儲存公告與會員的關聯

```sql
CREATE TABLE SDM_SHIP_ANNOUNCE_CUSTOMER (
    SHIP_ANNOUNCE_ID    NUMBER(10)      NOT NULL,
    SO_MEMBER_ID        NUMBER(10)      NOT NULL,
    READ_DATE           DATE,
    CONSTRAINT PK_ANNOUNCE_CUSTOMER
        PRIMARY KEY (SHIP_ANNOUNCE_ID, SO_MEMBER_ID)
);
```

**欄位說明**:

| 欄位名 | 資料型態 | 長度 | 必填 | 說明 |
|--------|----------|------|------|------|
| SHIP_ANNOUNCE_ID | NUMBER | 10 | Y | 公告ID (主鍵) |
| SO_MEMBER_ID | NUMBER | 10 | Y | 會員ID (主鍵) |
| READ_DATE | DATE | - | N | 閱讀日期 |

**約束**:
```sql
-- 外鍵約束
ALTER TABLE SDM_SHIP_ANNOUNCE_CUSTOMER
    ADD CONSTRAINT FK_ANNOUNCE_CUST_ANNOUNCE
    FOREIGN KEY (SHIP_ANNOUNCE_ID)
    REFERENCES SDM_SHIP_ANNOUNCE(SHIP_ANNOUNCE_ID);

ALTER TABLE SDM_SHIP_ANNOUNCE_CUSTOMER
    ADD CONSTRAINT FK_ANNOUNCE_CUST_MEMBER
    FOREIGN KEY (SO_MEMBER_ID)
    REFERENCES SDM_SO_MEMBER(SO_MEMBER_ID);
```

---

### 2.5 功能表

#### 2.5.1 SDM_SO_FUNC_W (功能工作表)

**表說明**: 儲存系統功能相關的工作資料

```sql
CREATE TABLE SDM_SO_FUNC_W (
    SO_FUNC_W_ID        NUMBER(10)      NOT NULL,
    FUNC_CODE           VARCHAR2(20)    NOT NULL,
    FUNC_NAME           VARCHAR2(100)   NOT NULL,
    FUNC_TYPE           VARCHAR2(10),
    FUNC_STATUS         VARCHAR2(10)    NOT NULL,
    ENTRY_DATE          DATE            NOT NULL,
    ENTRY_ID            VARCHAR2(20)    NOT NULL,
    TR_DATE             DATE,
    TR_ID               VARCHAR2(20),
    CONSTRAINT PK_SDM_SO_FUNC_W PRIMARY KEY (SO_FUNC_W_ID)
);
```

---

## 3. 索引設計

### 3.1 索引策略

#### 3.1.1 主鍵索引
所有表的主鍵自動建立唯一索引，使用B-Tree索引結構。

#### 3.1.2 外鍵索引
所有外鍵欄位建立索引，提升JOIN查詢效能。

#### 3.1.3 複合索引
針對常用的多欄位查詢條件建立複合索引。

**範例**:
```sql
-- 購物車查詢常用索引
CREATE INDEX IDX_CART_MEMBER_ITEM
    ON SDM_SO_SHOPPING_CART(SO_MEMBER_ID, SO_ITEM_ID, PART_ID);

-- 訂單查詢常用索引
CREATE INDEX IDX_ORDER_MEMBER_DATE
    ON SDM_SO_ORDER_HEAD(SO_MEMBER_ID, ORDER_DATE);
```

#### 3.1.4 函數索引
針對常用的函數查詢建立函數索引。

**範例**:
```sql
-- 訂單號碼大寫查詢
CREATE INDEX IDX_ORDER_NO_UPPER
    ON SDM_SO_ORDER_HEAD(UPPER(ORDER_NO));
```

---

## 4. 存儲過程

### 4.1 會員相關存儲過程

#### 4.1.1 LOGIN_CHECK (登入驗證)

```sql
CREATE OR REPLACE PROCEDURE LOGIN_CHECK (
    P_MEMBER_NO     IN  VARCHAR2,
    P_PASSWORD      IN  VARCHAR2,
    P_RESULT        OUT NUMBER,
    P_MEMBER_INFO   OUT SYS_REFCURSOR
)
AS
BEGIN
    -- 驗證會員帳號密碼
    OPEN P_MEMBER_INFO FOR
        SELECT
            SO_MEMBER_ID,
            SO_MEMBER_NO,
            SO_MEMBER_NAME,
            SO_STORE_ID,
            DEFAULT_LANGUAGE_ID,
            DEFAULT_DATE_TYPE
        FROM SDM_SO_MEMBER
        WHERE SO_MEMBER_NO = P_MEMBER_NO
          AND PASSWORD = P_PASSWORD
          AND SO_MEMBER_STATUS = 'A';

    -- 檢查是否找到會員
    IF SQL%ROWCOUNT > 0 THEN
        P_RESULT := 0;  -- 成功
    ELSE
        P_RESULT := -1; -- 失敗
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        P_RESULT := -99;
        RAISE;
END LOGIN_CHECK;
/
```

**參數說明**:
- `P_MEMBER_NO`: 會員編號 (IN)
- `P_PASSWORD`: 密碼 (IN)
- `P_RESULT`: 結果代碼 (OUT)
  - 0: 成功
  - -1: 帳號密碼錯誤
  - -99: 系統錯誤
- `P_MEMBER_INFO`: 會員資訊游標 (OUT)

---

#### 4.1.2 UPDATE_PASSWORD (修改密碼)

```sql
CREATE OR REPLACE PROCEDURE UPDATE_PASSWORD (
    P_MEMBER_ID     IN  NUMBER,
    P_OLD_PASSWORD  IN  VARCHAR2,
    P_NEW_PASSWORD  IN  VARCHAR2,
    P_RESULT        OUT NUMBER
)
AS
    V_COUNT NUMBER;
BEGIN
    -- 驗證舊密碼
    SELECT COUNT(*)
    INTO V_COUNT
    FROM SDM_SO_MEMBER
    WHERE SO_MEMBER_ID = P_MEMBER_ID
      AND PASSWORD = P_OLD_PASSWORD;

    IF V_COUNT = 0 THEN
        P_RESULT := -1; -- 舊密碼錯誤
        RETURN;
    END IF;

    -- 更新密碼
    UPDATE SDM_SO_MEMBER
    SET PASSWORD = P_NEW_PASSWORD,
        TR_DATE = SYSDATE,
        TR_ID = 'SYSTEM'
    WHERE SO_MEMBER_ID = P_MEMBER_ID;

    COMMIT;
    P_RESULT := 0; -- 成功

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        P_RESULT := -99;
        RAISE;
END UPDATE_PASSWORD;
/
```

---

### 4.2 購物車相關存儲過程

#### 4.2.1 ADD_TO_CART (加入購物車)

```sql
CREATE OR REPLACE PROCEDURE ADD_TO_CART (
    P_MEMBER_ID     IN  NUMBER,
    P_ITEM_ID       IN  NUMBER,
    P_PART_ID       IN  NUMBER,
    P_QTY           IN  NUMBER,
    P_RESULT        OUT NUMBER
)
AS
    V_CART_ID   NUMBER;
    V_COUNT     NUMBER;
BEGIN
    -- 檢查商品是否已在購物車
    SELECT COUNT(*)
    INTO V_COUNT
    FROM SDM_SO_SHOPPING_CART
    WHERE SO_MEMBER_ID = P_MEMBER_ID
      AND SO_ITEM_ID = P_ITEM_ID
      AND PART_ID = P_PART_ID;

    IF V_COUNT > 0 THEN
        -- 更新數量
        UPDATE SDM_SO_SHOPPING_CART
        SET QTY = QTY + P_QTY,
            TR_DATE = SYSDATE,
            TR_ID = 'SYSTEM'
        WHERE SO_MEMBER_ID = P_MEMBER_ID
          AND SO_ITEM_ID = P_ITEM_ID
          AND PART_ID = P_PART_ID;
    ELSE
        -- 新增記錄
        SELECT NVL(MAX(SO_SHOPPING_CART_ID), 0) + 1
        INTO V_CART_ID
        FROM SDM_SO_SHOPPING_CART;

        INSERT INTO SDM_SO_SHOPPING_CART (
            SO_SHOPPING_CART_ID,
            SO_MEMBER_ID,
            SO_ITEM_ID,
            PART_ID,
            QTY,
            ENTRY_DATE,
            ENTRY_ID
        ) VALUES (
            V_CART_ID,
            P_MEMBER_ID,
            P_ITEM_ID,
            P_PART_ID,
            P_QTY,
            SYSDATE,
            'SYSTEM'
        );
    END IF;

    COMMIT;
    P_RESULT := 0; -- 成功

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        P_RESULT := -99;
        RAISE;
END ADD_TO_CART;
/
```

---

#### 4.2.2 GET_CART_SUMMARY (取得購物車摘要)

```sql
CREATE OR REPLACE PROCEDURE GET_CART_SUMMARY (
    P_MEMBER_ID     IN  NUMBER,
    P_LANGUAGE_ID   IN  NUMBER,
    P_RESULT        OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN P_RESULT FOR
        SELECT
            COUNT(*) AS ITEM_COUNT,
            SUM(C.QTY) AS TOTAL_QTY,
            SUM(C.QTY * P.PRICE) AS TOTAL_AMOUNT
        FROM SDM_SO_SHOPPING_CART C
        JOIN PART P ON C.PART_ID = P.PART_ID
        WHERE C.SO_MEMBER_ID = P_MEMBER_ID;

END GET_CART_SUMMARY;
/
```

---

### 4.3 訂單相關存儲過程

#### 4.3.1 CREATE_ORDER (建立訂單)

```sql
CREATE OR REPLACE PROCEDURE CREATE_ORDER (
    P_MEMBER_ID     IN  NUMBER,
    P_ORDER_ID      OUT NUMBER,
    P_ORDER_NO      OUT VARCHAR2,
    P_RESULT        OUT NUMBER
)
AS
    V_ORDER_DATE    DATE;
    V_DETAIL_ID     NUMBER;
    V_LINE_NO       NUMBER := 0;

    CURSOR C_CART IS
        SELECT
            C.SO_ITEM_ID,
            C.PART_ID,
            C.QTY,
            P.PRICE
        FROM SDM_SO_SHOPPING_CART C
        JOIN PART P ON C.PART_ID = P.PART_ID
        WHERE C.SO_MEMBER_ID = P_MEMBER_ID;

BEGIN
    -- 檢查購物車是否有商品
    IF SQL%ROWCOUNT = 0 THEN
        P_RESULT := -1; -- 購物車為空
        RETURN;
    END IF;

    -- 產生訂單ID和訂單號
    SELECT NVL(MAX(SO_ORDER_HEAD_ID), 0) + 1
    INTO P_ORDER_ID
    FROM SDM_SO_ORDER_HEAD;

    V_ORDER_DATE := SYSDATE;
    P_ORDER_NO := 'SO' || TO_CHAR(V_ORDER_DATE, 'YYYYMMDD') ||
                  LPAD(P_ORDER_ID, 4, '0');

    -- 建立訂單表頭
    INSERT INTO SDM_SO_ORDER_HEAD (
        SO_ORDER_HEAD_ID,
        SO_MEMBER_ID,
        ORDER_NO,
        ORDER_DATE,
        ORDER_STATUS,
        ENTRY_DATE,
        ENTRY_ID
    ) VALUES (
        P_ORDER_ID,
        P_MEMBER_ID,
        P_ORDER_NO,
        V_ORDER_DATE,
        'NEW',
        SYSDATE,
        'SYSTEM'
    );

    -- 建立訂單明細
    FOR R_CART IN C_CART LOOP
        V_LINE_NO := V_LINE_NO + 1;

        SELECT NVL(MAX(SO_ORDER_DETAIL_ID), 0) + 1
        INTO V_DETAIL_ID
        FROM SDM_SO_ORDER_DETAIL;

        INSERT INTO SDM_SO_ORDER_DETAIL (
            SO_ORDER_DETAIL_ID,
            SO_ORDER_HEAD_ID,
            LINE_NO,
            SO_ITEM_ID,
            PART_ID,
            QTY,
            UNIT_PRICE,
            AMOUNT,
            ENTRY_DATE,
            ENTRY_ID
        ) VALUES (
            V_DETAIL_ID,
            P_ORDER_ID,
            V_LINE_NO,
            R_CART.SO_ITEM_ID,
            R_CART.PART_ID,
            R_CART.QTY,
            R_CART.PRICE,
            R_CART.QTY * R_CART.PRICE,
            SYSDATE,
            'SYSTEM'
        );
    END LOOP;

    -- 更新訂單總計
    UPDATE SDM_SO_ORDER_HEAD
    SET TOTAL_QTY = (
            SELECT SUM(QTY)
            FROM SDM_SO_ORDER_DETAIL
            WHERE SO_ORDER_HEAD_ID = P_ORDER_ID
        ),
        TOTAL_AMOUNT = (
            SELECT SUM(AMOUNT)
            FROM SDM_SO_ORDER_DETAIL
            WHERE SO_ORDER_HEAD_ID = P_ORDER_ID
        )
    WHERE SO_ORDER_HEAD_ID = P_ORDER_ID;

    -- 清空購物車
    DELETE FROM SDM_SO_SHOPPING_CART
    WHERE SO_MEMBER_ID = P_MEMBER_ID;

    COMMIT;
    P_RESULT := 0; -- 成功

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        P_RESULT := -99;
        RAISE;
END CREATE_ORDER;
/
```

---

#### 4.3.2 CANCEL_ORDER (取消訂單)

```sql
CREATE OR REPLACE PROCEDURE CANCEL_ORDER (
    P_MEMBER_ID     IN  NUMBER,
    P_ORDER_ID      IN  NUMBER,
    P_RESULT        OUT NUMBER
)
AS
    V_STATUS    VARCHAR2(10);
BEGIN
    -- 檢查訂單狀態
    SELECT ORDER_STATUS
    INTO V_STATUS
    FROM SDM_SO_ORDER_HEAD
    WHERE SO_ORDER_HEAD_ID = P_ORDER_ID
      AND SO_MEMBER_ID = P_MEMBER_ID;

    -- 只有NEW和CONFIRMED狀態可以取消
    IF V_STATUS NOT IN ('NEW', 'CONFIRMED') THEN
        P_RESULT := -1; -- 訂單狀態不允許取消
        RETURN;
    END IF;

    -- 更新訂單狀態
    UPDATE SDM_SO_ORDER_HEAD
    SET ORDER_STATUS = 'CANCELLED',
        TR_DATE = SYSDATE,
        TR_ID = 'SYSTEM'
    WHERE SO_ORDER_HEAD_ID = P_ORDER_ID;

    COMMIT;
    P_RESULT := 0; -- 成功

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        P_RESULT := -2; -- 訂單不存在
    WHEN OTHERS THEN
        ROLLBACK;
        P_RESULT := -99;
        RAISE;
END CANCEL_ORDER;
/
```

---

## 5. 視圖設計

### 5.1 CMM_CUSTOMER_V (客戶視圖)

**視圖說明**: 整合客戶相關資訊的視圖

```sql
CREATE OR REPLACE VIEW CMM_CUSTOMER_V AS
SELECT
    M.SO_MEMBER_ID,
    M.SO_MEMBER_NO,
    M.SO_MEMBER_NAME,
    M.E_MAIL,
    M.TEL_NO,
    M.MOBILE_PHONE_NO,
    M.SO_STORE_ID,
    S.STORE_NAME,
    M.SO_MEMBER_STATUS,
    M.ENTRY_DATE
FROM SDM_SO_MEMBER M
LEFT JOIN STORE S ON M.SO_STORE_ID = S.STORE_ID;
```

---

### 5.2 V_ORDER_SUMMARY (訂單摘要視圖)

**視圖說明**: 訂單摘要資訊視圖

```sql
CREATE OR REPLACE VIEW V_ORDER_SUMMARY AS
SELECT
    H.SO_ORDER_HEAD_ID,
    H.ORDER_NO,
    H.ORDER_DATE,
    H.ORDER_STATUS,
    M.SO_MEMBER_NO,
    M.SO_MEMBER_NAME,
    H.TOTAL_QTY,
    H.TOTAL_AMOUNT,
    COUNT(D.SO_ORDER_DETAIL_ID) AS ITEM_COUNT
FROM SDM_SO_ORDER_HEAD H
JOIN SDM_SO_MEMBER M ON H.SO_MEMBER_ID = M.SO_MEMBER_ID
LEFT JOIN SDM_SO_ORDER_DETAIL D ON H.SO_ORDER_HEAD_ID = D.SO_ORDER_HEAD_ID
GROUP BY
    H.SO_ORDER_HEAD_ID,
    H.ORDER_NO,
    H.ORDER_DATE,
    H.ORDER_STATUS,
    M.SO_MEMBER_NO,
    M.SO_MEMBER_NAME,
    H.TOTAL_QTY,
    H.TOTAL_AMOUNT;
```

---

## 6. 觸發器

### 6.1 TRG_ORDER_DETAIL_AMOUNT (訂單明細金額觸發器)

**觸發器說明**: 自動計算訂單明細金額

```sql
CREATE OR REPLACE TRIGGER TRG_ORDER_DETAIL_AMOUNT
BEFORE INSERT OR UPDATE ON SDM_SO_ORDER_DETAIL
FOR EACH ROW
BEGIN
    :NEW.AMOUNT := :NEW.QTY * :NEW.UNIT_PRICE;
END;
/
```

---

### 6.2 TRG_ORDER_HEAD_TOTAL (訂單總計觸發器)

**觸發器說明**: 自動更新訂單總計

```sql
CREATE OR REPLACE TRIGGER TRG_ORDER_HEAD_TOTAL
AFTER INSERT OR UPDATE OR DELETE ON SDM_SO_ORDER_DETAIL
FOR EACH ROW
DECLARE
    V_ORDER_ID NUMBER;
BEGIN
    IF INSERTING OR UPDATING THEN
        V_ORDER_ID := :NEW.SO_ORDER_HEAD_ID;
    ELSE
        V_ORDER_ID := :OLD.SO_ORDER_HEAD_ID;
    END IF;

    UPDATE SDM_SO_ORDER_HEAD
    SET TOTAL_QTY = (
            SELECT NVL(SUM(QTY), 0)
            FROM SDM_SO_ORDER_DETAIL
            WHERE SO_ORDER_HEAD_ID = V_ORDER_ID
        ),
        TOTAL_AMOUNT = (
            SELECT NVL(SUM(AMOUNT), 0)
            FROM SDM_SO_ORDER_DETAIL
            WHERE SO_ORDER_HEAD_ID = V_ORDER_ID
        )
    WHERE SO_ORDER_HEAD_ID = V_ORDER_ID;
END;
/
```

---

## 7. 資料字典

### 7.1 狀態代碼

#### 7.1.1 會員狀態 (SO_MEMBER_STATUS)

| 代碼 | 說明 |
|------|------|
| A | 啟用 (Active) |
| I | 停用 (Inactive) |

#### 7.1.2 訂單狀態 (ORDER_STATUS)

| 代碼 | 說明 |
|------|------|
| NEW | 新建 |
| CONFIRMED | 已確認 |
| PROCESSING | 處理中 |
| SHIPPED | 已出貨 |
| COMPLETED | 已完成 |
| CANCELLED | 已取消 |

#### 7.1.3 公告狀態 (ANNOUNCE_STATUS)

| 代碼 | 說明 |
|------|------|
| A | 啟用 (Active) |
| I | 停用 (Inactive) |

---

### 7.2 序列 (Sequence)

```sql
-- 會員ID序列
CREATE SEQUENCE SEQ_SO_MEMBER_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- 購物車ID序列
CREATE SEQUENCE SEQ_SHOPPING_CART_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- 訂單ID序列
CREATE SEQUENCE SEQ_ORDER_HEAD_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- 訂單明細ID序列
CREATE SEQUENCE SEQ_ORDER_DETAIL_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;
```

---

### 7.3 資料庫維護

#### 7.3.1 統計資訊更新

```sql
-- 更新表統計資訊
BEGIN
    DBMS_STATS.GATHER_TABLE_STATS('PRG', 'SDM_SO_MEMBER');
    DBMS_STATS.GATHER_TABLE_STATS('PRG', 'SDM_SO_SHOPPING_CART');
    DBMS_STATS.GATHER_TABLE_STATS('PRG', 'SDM_SO_ORDER_HEAD');
    DBMS_STATS.GATHER_TABLE_STATS('PRG', 'SDM_SO_ORDER_DETAIL');
END;
/
```

#### 7.3.2 索引重建

```sql
-- 重建索引
ALTER INDEX PK_SDM_SO_MEMBER REBUILD;
ALTER INDEX PK_SDM_SO_SHOPPING_CART REBUILD;
ALTER INDEX PK_SDM_SO_ORDER_HEAD REBUILD;
ALTER INDEX PK_SDM_SO_ORDER_DETAIL REBUILD;
```

---

**文件結束**

# SDM 銷售訂單系統 - 技術文件 (類別與方法說明)

## 文件資訊
- **專案名稱**: SDM Sale Order System
- **文件類型**: 技術文件 - 類別與方法詳細說明
- **建立日期**: 2026-01-26
- **適用對象**: 開發人員、維護人員

---

## 目錄
1. [Controller層](#1-controller層)
2. [Service層](#2-service層)
3. [Repository層](#3-repository層)
4. [Entity層](#4-entity層)
5. [Utility層](#5-utility層)
6. [Filter層](#6-filter層)
7. [Configuration層](#7-configuration層)

---

## 1. Controller層

### 1.1 CustomerController

**路徑**: `com.sdm.controller.CustomerController`

**職責**: 處理會員相關的HTTP請求，包括登入、會員資料管理、密碼管理、公告查詢等。

#### 1.1.1 類別屬性

```java
@Autowired
private Producer captchaProducer;  // 驗證碼生成器

@Autowired
private SdmShipAnnounceService sdmShipAnnounceService;  // 公告服務

@Autowired
private SdmSoFuncWService sdmSoFuncWService;  // 功能服務

@Autowired
private SdmSoMemberService sdmSoMemberService;  // 會員服務
```

#### 1.1.2 主要方法

##### loginCheck()
```java
@RequestMapping(value="/loginCheck", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> loginCheck(
    Model model,
    HttpServletResponse response,
    HttpServletRequest request
)
```

**功能**: 處理會員登入驗證

**流程**:
1. 取得請求參數 (username, password, code)
2. 驗證驗證碼是否正確
3. 調用Service層驗證帳號密碼
4. 驗證成功後建立Session，儲存LoginMember
5. 返回登入結果

**參數**:
- `username`: 會員帳號
- `password`: 會員密碼
- `code`: 驗證碼

**返回**:
```json
{
  "success": true/false,
  "message": "登入成功/失敗訊息",
  "redirectUrl": "/index"
}
```

##### getKaptchaImage()
```java
@RequestMapping(value="/getKaptchaImage", method=RequestMethod.GET)
public void getKaptchaImage(
    HttpServletResponse response,
    HttpSession session
) throws Exception
```

**功能**: 生成驗證碼圖片

**流程**:
1. 使用Kaptcha生成驗證碼文字
2. 將驗證碼文字儲存到Session
3. 生成驗證碼圖片
4. 將圖片輸出到Response

**Session儲存**:
- Key: `Constants.KAPTCHA_SESSION_KEY`
- Value: 驗證碼文字

##### index()
```java
@RequestMapping(value="/index", method=RequestMethod.GET)
public String index(
    Model model,
    HttpSession session,
    HttpServletResponse response,
    HttpServletRequest request
)
```

**功能**: 顯示系統首頁

**流程**:
1. 從Session取得LoginMember
2. 查詢會員的公告資訊
3. 查詢客服資訊
4. 將資料加入Model
5. 返回index.jsp視圖

**Model屬性**:
- `jsonSdmShipAnnounce`: 公告JSON字串
- `jsonServiceInfo`: 客服資訊JSON字串

##### getMemberData()
```java
@RequestMapping(value="/getMemberData", method=RequestMethod.GET)
@ResponseBody
public Map<String, Object> getMemberData(
    Model model,
    HttpServletResponse response,
    HttpSession session
)
```

**功能**: 取得會員資料

**流程**:
1. 從Session取得LoginMember
2. 調用Service查詢完整會員資料
3. 返回會員資料JSON

**返回**:
```json
{
  "soMemberId": 123,
  "soMemberNo": "M001",
  "soMemberName": "張三",
  "email": "test@example.com",
  "telNo": "02-12345678",
  "mobilePhoneNo": "0912345678",
  ...
}
```

##### postUpdtMember()
```java
@RequestMapping(value="/postUpdtMember", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> postUpdtMember(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 更新會員資料

**流程**:
1. 從Session取得LoginMember
2. 從Request取得更新參數
3. 調用Service更新會員資料
4. 返回更新結果

**參數**:
- `soMemberName`: 會員姓名
- `email`: 電子郵件
- `telNo`: 電話號碼
- `mobilePhoneNo`: 手機號碼
- `faxNo`: 傳真號碼

##### postUpdtPassword()
```java
@RequestMapping(value="/postUpdtPassword", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> postUpdtPassword(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 修改會員密碼

**流程**:
1. 從Session取得LoginMember
2. 取得舊密碼、新密碼、確認密碼
3. 驗證新密碼與確認密碼是否一致
4. 調用Service更新密碼
5. 返回更新結果

**參數**:
- `oldPassword`: 舊密碼
- `newPassword`: 新密碼
- `newPassword2`: 確認新密碼

---

### 1.2 ProductController

**路徑**: `com.sdm.controller.ProductController`

**職責**: 處理產品相關的HTTP請求，包括產品分類、系列、品項查詢等。

#### 1.2.1 類別屬性

```java
@Autowired
private SdmSoFuncWService sdmSoFuncWService;  // 功能服務
```

#### 1.2.2 主要方法

##### getIemKindJsonByCategory()
```java
@RequestMapping(value="/getIemKindJsonByCategory", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getIemKindJsonByCategory(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 根據產品類別取得品種列表

**參數**:
- `categoryId`: 產品類別ID
- `languageId`: 語言ID
- `deliveryToConsumerYn`: 是否配送到消費者

**返回**:
```json
[
  {
    "KIND_ID": 1,
    "KIND_NAME": "品種名稱",
    "CATEGORY_ID": 1,
    ...
  }
]
```

##### getSeriesJsonByKind()
```java
@RequestMapping(value="/getSeriesJsonByKind", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getSeriesJsonByKind(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 根據品種取得系列列表

**參數**:
- `kindId`: 品種ID
- `categoryId`: 類別ID
- `languageId`: 語言ID

**返回**:
```json
[
  {
    "SERIES_ID": 1,
    "SERIES_NAME": "系列名稱",
    "KIND_ID": 1,
    ...
  }
]
```

##### getIemJsonBySeries()
```java
@RequestMapping(value="/getIemJsonBySeries", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getIemJsonBySeries(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 根據系列取得產品品項列表

**參數**:
- `seriesId`: 系列ID
- `languageId`: 語言ID

**返回**:
```json
[
  {
    "ITEM_ID": 1,
    "ITEM_NO": "P001",
    "ITEM_NAME": "產品名稱",
    "PRICE": 100.00,
    "SERIES_ID": 1,
    ...
  }
]
```

##### getItemJsonByKeyword()
```java
@RequestMapping(value="/getItemJsonByKeyword", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getItemJsonByKeyword(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 根據關鍵字搜尋產品

**參數**:
- `keyword`: 搜尋關鍵字
- `languageId`: 語言ID

**返回**: 產品列表JSON (格式同getIemJsonBySeries)

##### getItemImageJson()
```java
@RequestMapping(value="/getItemImageJson", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getItemImageJson(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得產品圖片資訊

**參數**:
- `editPartGroupId`: 產品群組ID
- `languageId`: 語言ID

**返回**:
```json
[
  {
    "IMAGE_URL": "http://example.com/image.jpg",
    "IMAGE_TYPE": "MAIN",
    "SEQ": 1,
    ...
  }
]
```

##### getPartDegreeJson()
```java
@RequestMapping(value="/getPartDegreeJson", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getPartDegreeJson(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得產品規格資訊

**參數**:
- `editPartGroupId`: 產品群組ID
- `languageId`: 語言ID

**返回**:
```json
[
  {
    "PART_ID": 1,
    "DEGREE": "度數",
    "BC": "基弧",
    "DIA": "直徑",
    "PRICE": 100.00,
    ...
  }
]
```

---

### 1.3 OrderController

**路徑**: `com.sdm.controller.OrderController`

**職責**: 處理訂單和購物車相關的HTTP請求。

#### 1.3.1 類別屬性

```java
@Autowired
private SdmSoFuncWService sdmSoFuncWService;  // 功能服務

@Autowired
private SdmSoShoppingCartService sdmSoShoppingCartService;  // 購物車服務

@Autowired
private SdmSoOrderHeadService sdmSoOrderHeadService;  // 訂單服務

@Autowired
private UfmService ufmService;  // UFM服務
```

#### 1.3.2 購物車相關方法

##### postAddPartToCart()
```java
@RequestMapping(value="/postAddPartToCart", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> postAddPartToCart(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 加入商品到購物車

**流程**:
1. 從Session取得LoginMember
2. 取得商品參數 (itemId, partId, qty)
3. 調用Service加入購物車
4. 返回操作結果

**參數**:
- `soItemId`: 產品ID
- `partId`: 規格ID
- `qty`: 數量

**返回**:
```json
{
  "success": true,
  "message": "加入購物車成功"
}
```

##### getCartCount()
```java
@RequestMapping(value="/getCartCount", method=RequestMethod.GET)
@ResponseBody
public Map<String, Object> getCartCount(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得購物車商品數量

**返回**:
```json
{
  "count": 5
}
```

##### getCartSummary()
```java
@RequestMapping(value="/getCartSummary", method=RequestMethod.GET)
@ResponseBody
public Map<String, Object> getCartSummary(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得購物車摘要資訊

**返回**:
```json
{
  "totalQty": 10,
  "totalAmount": 1000.00,
  "itemCount": 3
}
```

##### getCartHeadDetail()
```java
@RequestMapping(value="/getCartHeadDetail", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getCartHeadDetail(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得購物車詳細資料

**返回**:
```json
[
  {
    "CART_ID": 1,
    "ITEM_NAME": "產品名稱",
    "PART_DEGREE": "度數",
    "QTY": 2,
    "UNIT_PRICE": 100.00,
    "AMOUNT": 200.00,
    ...
  }
]
```

##### updtShoppinCart()
```java
@RequestMapping(value="/updtShoppinCart", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> updtShoppinCart(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 更新購物車商品數量

**參數**:
- `cartId`: 購物車ID
- `qty`: 新數量

**返回**:
```json
{
  "success": true,
  "message": "更新成功"
}
```

##### delShoppinCart()
```java
@RequestMapping(value="/delShoppinCart", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> delShoppinCart(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 刪除購物車商品

**參數**:
- `cartId`: 購物車ID

**返回**:
```json
{
  "success": true,
  "message": "刪除成功"
}
```

##### postBatchDelShoppingCart()
```java
@RequestMapping(value="/postBatchDelShoppingCart", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> postBatchDelShoppingCart(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 批次刪除購物車商品

**參數**:
- `partIdJson`: 商品ID陣列的JSON字串

**返回**:
```json
{
  "success": true,
  "message": "批次刪除成功"
}
```

##### postTransferToSale()
```java
@RequestMapping(value="/postTransferToSale", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> postTransferToSale(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 將購物車轉為訂單

**流程**:
1. 從Session取得LoginMember
2. 驗證購物車是否有商品
3. 調用Service建立訂單
4. 清空購物車
5. 返回訂單建立結果

**返回**:
```json
{
  "success": true,
  "orderId": 123,
  "orderNo": "SO202601260001",
  "message": "訂單建立成功"
}
```

#### 1.3.3 訂單相關方法

##### getOrders()
```java
@RequestMapping(value="/getOrders", method=RequestMethod.GET)
@ResponseBody
public List<Map<String, Object>> getOrders(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得訂單列表

**參數**:
- `startDate`: 開始日期
- `endDate`: 結束日期
- `orderStatus`: 訂單狀態

**返回**:
```json
[
  {
    "ORDER_ID": 1,
    "ORDER_NO": "SO202601260001",
    "ORDER_DATE": "2026-01-26",
    "ORDER_STATUS": "已確認",
    "TOTAL_AMOUNT": 1000.00,
    ...
  }
]
```

##### getOrderDetails()
```java
@RequestMapping(value="/getOrderDetails", method=RequestMethod.GET)
@ResponseBody
public Map<String, Object> getOrderDetails(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取得訂單詳情

**參數**:
- `orderId`: 訂單ID

**返回**:
```json
{
  "orderHead": {
    "ORDER_ID": 1,
    "ORDER_NO": "SO202601260001",
    "ORDER_DATE": "2026-01-26",
    ...
  },
  "orderDetails": [
    {
      "DETAIL_ID": 1,
      "ITEM_NAME": "產品名稱",
      "QTY": 2,
      "UNIT_PRICE": 100.00,
      "AMOUNT": 200.00,
      ...
    }
  ]
}
```

##### delOrder()
```java
@RequestMapping(value="/delOrder", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> delOrder(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 取消訂單

**參數**:
- `orderId`: 訂單ID

**返回**:
```json
{
  "success": true,
  "message": "訂單已取消"
}
```

##### copyOrder()
```java
@RequestMapping(value="/copyOrder", method=RequestMethod.POST)
@ResponseBody
public Map<String, Object> copyOrder(
    Model model,
    HttpSession session,
    HttpServletRequest request
)
```

**功能**: 複製訂單到購物車

**流程**:
1. 取得訂單ID
2. 查詢訂單明細
3. 將訂單明細複製到購物車
4. 返回操作結果

**參數**:
- `orderId`: 訂單ID

**返回**:
```json
{
  "success": true,
  "message": "訂單已複製到購物車"
}
```

---

## 2. Service層

### 2.1 SdmSoFuncWService

**路徑**: `com.sdm.service.SdmSoFuncWService`

**職責**: 提供核心業務邏輯，主要透過調用Oracle存儲過程實現各種功能。

#### 2.1.1 類別屬性

```java
@Autowired
private SdmSoFuncWRepo sdmSoFuncWRepo;  // Repository

@Autowired
private SdmSoMemberRepo sdmSoMemberRepo;  // 會員Repository
```

#### 2.1.2 會員相關方法

##### getShipAnnounceInfoBySoMemberId()
```java
public List<Map<String, Object>> getShipAnnounceInfoBySoMemberId(
    BigDecimal soMemberId
)
```

**功能**: 取得會員的公告資訊

**流程**:
1. 調用存儲過程查詢公告
2. 處理CLOB類型欄位
3. 返回公告列表

**返回**: 公告資訊列表

##### getServiceInfoBySoMemberId()
```java
public List<Map<String, Object>> getServiceInfoBySoMemberId(
    BigDecimal soMemberId
)
```

**功能**: 取得會員的客服資訊

**返回**: 客服資訊列表

##### uptPassword()
```java
public Map<String, Object> uptPassword(
    BigDecimal soMemberId,
    String oldPassword,
    String newPassword,
    String newPassword2
)
```

**功能**: 修改會員密碼

**流程**:
1. 驗證新密碼與確認密碼是否一致
2. 調用存儲過程驗證舊密碼
3. 更新密碼
4. 返回操作結果

**參數**:
- `soMemberId`: 會員ID
- `oldPassword`: 舊密碼
- `newPassword`: 新密碼
- `newPassword2`: 確認新密碼

#### 2.1.3 產品相關方法

##### getItemCategoryAndKindByCustomerId()
```java
public List<Map<String, Object>> getItemCategoryAndKindByCustomerId(
    BigDecimal soMemberId,
    BigDecimal languageId,
    String deliveryToConsumerYn
)
```

**功能**: 取得產品分類和品種

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `deliveryToConsumerYn`: 是否配送到消費者

**返回**: 分類和品種列表

##### getSeriesByCustomerId()
```java
public List<Map<String, Object>> getSeriesByCustomerId(
    BigDecimal soMemberId,
    BigDecimal languageId,
    BigDecimal soItmCategoryId,
    BigDecimal soItemKindId
)
```

**功能**: 取得產品系列

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `soItmCategoryId`: 類別ID
- `soItemKindId`: 品種ID

**返回**: 系列列表

##### getItemBySeriesCustomerId()
```java
public List<Map<String, Object>> getItemBySeriesCustomerId(
    BigDecimal soMemberId,
    BigDecimal languageId,
    BigDecimal soSeriesPartGroupId
)
```

**功能**: 根據系列取得產品品項

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `soSeriesPartGroupId`: 系列ID

**返回**: 產品品項列表

##### getItemByKeyword()
```java
public List<Map<String, Object>> getItemByKeyword(
    BigDecimal soMemberId,
    BigDecimal languageId,
    String keyword
)
```

**功能**: 根據關鍵字搜尋產品

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `keyword`: 搜尋關鍵字

**返回**: 產品列表

##### getItemImageByEditPartGroupId()
```java
public List<Map<String, Object>> getItemImageByEditPartGroupId(
    BigDecimal soMemberId,
    BigDecimal languageId,
    BigDecimal editPartGroupId
)
```

**功能**: 取得產品圖片

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `editPartGroupId`: 產品群組ID

**返回**: 產品圖片列表

##### getPartDegreeByEditPartGroupId()
```java
public List<Map<String, Object>> getPartDegreeByEditPartGroupId(
    BigDecimal editPartGroupId,
    BigDecimal languageId
)
```

**功能**: 取得產品規格

**參數**:
- `editPartGroupId`: 產品群組ID
- `languageId`: 語言ID

**返回**: 產品規格列表

#### 2.1.4 購物車相關方法

##### addToCart()
```java
public Map<String, Object> addToCart(
    BigDecimal soMemberId,
    BigDecimal soItemId,
    BigDecimal partId,
    BigDecimal qty
)
```

**功能**: 加入商品到購物車

**流程**:
1. 調用存儲過程檢查商品是否已在購物車
2. 如已存在則更新數量
3. 如不存在則新增記錄
4. 返回操作結果

**參數**:
- `soMemberId`: 會員ID
- `soItemId`: 產品ID
- `partId`: 規格ID
- `qty`: 數量

##### getShoppingCartBySoMemberId()
```java
public List<Map<String, Object>> getShoppingCartBySoMemberId(
    BigDecimal soMemberId,
    BigDecimal languageId
)
```

**功能**: 取得購物車列表

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID

**返回**: 購物車商品列表

##### getShoppingCartCountBySoMemberId()
```java
public Map<String, Object> getShoppingCartCountBySoMemberId(
    BigDecimal soMemberId,
    BigDecimal editPartGroupId
)
```

**功能**: 取得購物車商品數量

**參數**:
- `soMemberId`: 會員ID
- `editPartGroupId`: 產品群組ID (可選)

**返回**: 購物車數量資訊

##### getShoppingCartSummary()
```java
public Map<String, Object> getShoppingCartSummary(
    BigDecimal soMemberId,
    BigDecimal languageId
)
```

**功能**: 取得購物車摘要

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID

**返回**: 購物車摘要資訊 (總數量、總金額等)

##### updShoppingCartPartBySoMemberId()
```java
public Map<String, Object> updShoppingCartPartBySoMemberId(
    BigDecimal soMemberId,
    BigDecimal oldPartId,
    BigDecimal newPartId
)
```

**功能**: 更新購物車商品規格

**參數**:
- `soMemberId`: 會員ID
- `oldPartId`: 舊規格ID
- `newPartId`: 新規格ID

##### bhDelShoppingCartPartBySoMemberId()
```java
public Map<String, Object> bhDelShoppingCartPartBySoMemberId(
    BigDecimal soMemberId,
    String partIdJson
)
```

**功能**: 批次刪除購物車商品

**流程**:
1. 解析partIdJson取得商品ID陣列
2. 調用存儲過程批次刪除
3. 返回操作結果

**參數**:
- `soMemberId`: 會員ID
- `partIdJson`: 商品ID陣列的JSON字串

##### transferToSale()
```java
public Map<String, Object> transferToSale(
    BigDecimal soMemberId
)
```

**功能**: 將購物車轉為訂單

**流程**:
1. 調用存儲過程建立訂單
2. 清空購物車
3. 返回訂單資訊

**參數**:
- `soMemberId`: 會員ID

**返回**: 訂單資訊 (訂單ID、訂單號等)

#### 2.1.5 訂單相關方法

##### getOrderListByMemberId()
```java
public List<Map<String, Object>> getOrderListByMemberId(
    BigDecimal soMemberId,
    BigDecimal languageId,
    String startDate,
    String endDate,
    BigDecimal page
)
```

**功能**: 取得訂單列表

**參數**:
- `soMemberId`: 會員ID
- `languageId`: 語言ID
- `startDate`: 開始日期
- `endDate`: 結束日期
- `page`: 頁碼

**返回**: 訂單列表

##### getOrderDetailByOrderId()
```java
public List<Map<String, Object>> getOrderDetailByOrderId(
    BigDecimal soMemberId,
    BigDecimal soOrderHeadId,
    BigDecimal languageId
)
```

**功能**: 取得訂單明細

**參數**:
- `soMemberId`: 會員ID
- `soOrderHeadId`: 訂單ID
- `languageId`: 語言ID

**返回**: 訂單明細列表

##### cancelOrderById()
```java
public Map<String, Object> cancelOrderById(
    BigDecimal soMemberId,
    BigDecimal soOrderHeadId
)
```

**功能**: 取消訂單

**流程**:
1. 調用存儲過程驗證訂單狀態
2. 更新訂單狀態為已取消
3. 返回操作結果

**參數**:
- `soMemberId`: 會員ID
- `soOrderHeadId`: 訂單ID

##### copyOrderToCartById()
```java
public Map<String, Object> copyOrderToCartById(
    BigDecimal soMemberId,
    BigDecimal soOrderHeadId
)
```

**功能**: 複製訂單到購物車

**流程**:
1. 查詢訂單明細
2. 將明細逐一加入購物車
3. 返回操作結果

**參數**:
- `soMemberId`: 會員ID
- `soOrderHeadId`: 訂單ID

#### 2.1.6 工具方法

##### clobStringConversion()
```java
public String clobStringConversion(Clob clb)
    throws SQLException, IOException
```

**功能**: 將Oracle CLOB類型轉換為String

**流程**:
1. 檢查CLOB是否為null
2. 使用BufferedReader讀取CLOB內容
3. 拼接為字串返回

**參數**:
- `clb`: CLOB物件

**返回**: 字串內容

---

### 2.2 SdmSoMemberService

**路徑**: `com.sdm.service.SdmSoMemberService`

**職責**: 處理會員相關的業務邏輯。

#### 2.2.1 主要方法

##### findByMemberNoAndPassword()
```java
public SdmSoMember findByMemberNoAndPassword(
    String memberNo,
    String password
)
```

**功能**: 根據會員編號和密碼查詢會員

**流程**:
1. 對密碼進行加密
2. 調用Repository查詢會員
3. 返回會員物件

**參數**:
- `memberNo`: 會員編號
- `password`: 密碼 (明文)

**返回**: SdmSoMember物件或null

##### updateMember()
```java
public void updateMember(SdmSoMember member)
```

**功能**: 更新會員資料

**參數**:
- `member`: 會員物件

##### updatePassword()
```java
public boolean updatePassword(
    Long memberId,
    String oldPassword,
    String newPassword
)
```

**功能**: 更新會員密碼

**流程**:
1. 查詢會員
2. 驗證舊密碼
3. 更新為新密碼
4. 返回操作結果

**參數**:
- `memberId`: 會員ID
- `oldPassword`: 舊密碼
- `newPassword`: 新密碼

**返回**: true/false

---

### 2.3 SdmSoShoppingCartService

**路徑**: `com.sdm.service.SdmSoShoppingCartService`

**職責**: 處理購物車相關的業務邏輯。

#### 2.3.1 主要方法

##### addToCart()
```java
public void addToCart(
    BigDecimal memberId,
    BigDecimal itemId,
    BigDecimal partId,
    BigDecimal qty
)
```

**功能**: 加入商品到購物車

**流程**:
1. 檢查商品是否已在購物車
2. 如已存在則更新數量
3. 如不存在則新增記錄

##### updateCartQty()
```java
public void updateCartQty(
    Long cartId,
    BigDecimal qty
)
```

**功能**: 更新購物車數量

##### deleteCart()
```java
public void deleteCart(Long cartId)
```

**功能**: 刪除購物車商品

##### clearCart()
```java
public void clearCart(BigDecimal memberId)
```

**功能**: 清空購物車

---

### 2.4 SdmSoOrderHeadService

**路徑**: `com.sdm.service.SdmSoOrderHeadService`

**職責**: 處理訂單相關的業務邏輯。

#### 2.4.1 主要方法

##### createOrder()
```java
public Map<String, Object> createOrder(
    BigDecimal memberId,
    List<Map<String, Object>> cartItems
)
```

**功能**: 建立訂單

**流程**:
1. 建立訂單表頭
2. 建立訂單明細
3. 計算訂單金額
4. 返回訂單資訊

##### cancelOrder()
```java
public void cancelOrder(BigDecimal orderId)
```

**功能**: 取消訂單

**流程**:
1. 查詢訂單
2. 驗證訂單狀態
3. 更新訂單狀態為已取消

---

### 2.5 SdmShipAnnounceService

**路徑**: `com.sdm.service.SdmShipAnnounceService`

**職責**: 處理公告相關的業務邏輯。

#### 2.5.1 主要方法

##### getActiveAnnounces()
```java
public List<SdmShipAnnounce> getActiveAnnounces()
```

**功能**: 取得有效的公告列表

**流程**:
1. 查詢當前日期在有效期內的公告
2. 按開始日期排序
3. 返回公告列表

---

## 3. Repository層

### 3.1 SdmSoFuncWRepo

**路徑**: `com.sdm.dao.SdmSoFuncWRepo`

**職責**: 提供資料存取介面，主要調用Oracle存儲過程。

```java
@Repository
public interface SdmSoFuncWRepo extends JpaRepository<SdmSoFuncW, BigDecimal> {

    @Procedure(name = "procedureName")
    List<Object[]> callProcedure(
        @Param("param1") BigDecimal param1,
        @Param("param2") String param2
    );
}
```

**說明**:
- 繼承JpaRepository提供基本CRUD操作
- 使用@Procedure註解調用存儲過程
- 返回List<Object[]>格式的結果集

---

### 3.2 SdmSoMemberRepo

**路徑**: `com.sdm.dao.SdmSoMemberRepo`

**職責**: 提供會員資料存取介面。

```java
@Repository
public interface SdmSoMemberRepo extends JpaRepository<SdmSoMember, Long> {

    SdmSoMember findBySoMemberNoAndPassword(
        String soMemberNo,
        String password
    );

    SdmSoMember findBySoMemberNo(String soMemberNo);
}
```

---

### 3.3 SdmSoShoppingCartRepo

**路徑**: `com.sdm.dao.SdmSoShoppingCartRepo`

**職責**: 提供購物車資料存取介面。

```java
@Repository
public interface SdmSoShoppingCartRepo
    extends JpaRepository<SdmSoShoppingCart, Long> {

    List<SdmSoShoppingCart> findBySoMemberId(BigDecimal soMemberId);

    void deleteBySoMemberId(BigDecimal soMemberId);
}
```

---

### 3.4 SdmShipAnnounceRepo

**路徑**: `com.sdm.dao.SdmShipAnnounceRepo`

**職責**: 提供公告資料存取介面。

```java
@Repository
public interface SdmShipAnnounceRepo
    extends JpaRepository<SdmShipAnnounce, Long> {

    @Query("SELECT s FROM SdmShipAnnounce s " +
           "WHERE s.startDate <= :currentDate " +
           "AND s.endDate >= :currentDate " +
           "ORDER BY s.startDate DESC")
    List<SdmShipAnnounce> findActiveAnnounces(
        @Param("currentDate") Date currentDate
    );
}
```

---

## 4. Entity層

### 4.1 SdmSoMember

**路徑**: `com.sdm.entity.SdmSoMember`

**職責**: 會員實體類別，對應資料庫表 SDM_SO_MEMBER。

```java
@Entity
@Table(name="SDM_SO_MEMBER")
public class SdmSoMember implements Serializable {

    @Id
    @Column(name="SO_MEMBER_ID")
    private Long soMemberId;

    @Column(name="SO_MEMBER_NO")
    private String soMemberNo;

    @Column(name="SO_MEMBER_NAME")
    private String soMemberName;

    @Column(name="PASSWORD")
    private String password;

    @Column(name="E_MAIL")
    private String eMail;

    // ... 其他欄位和getter/setter
}
```

**主要欄位**:
- `soMemberId`: 會員ID (主鍵)
- `soMemberNo`: 會員編號
- `soMemberName`: 會員名稱
- `password`: 密碼 (加密)
- `eMail`: 電子郵件
- `telNo`: 電話號碼
- `mobilePhoneNo`: 手機號碼

---

### 4.2 SdmSoShoppingCart

**路徑**: `com.sdm.entity.SdmSoShoppingCart`

**職責**: 購物車實體類別，對應資料庫表 SDM_SO_SHOPPING_CART。

```java
@Entity
@Table(name="SDM_SO_SHOPPING_CART")
public class SdmSoShoppingCart implements Serializable {

    @Id
    @Column(name="SO_SHOPPING_CART_ID")
    private Long soShoppingCartId;

    @Column(name="SO_MEMBER_ID")
    private BigDecimal soMemberId;

    @Column(name="SO_ITEM_ID")
    private BigDecimal soItemId;

    @Column(name="PART_ID")
    private BigDecimal partId;

    @Column(name="QTY")
    private BigDecimal qty;

    // ... 其他欄位和getter/setter
}
```

---

### 4.3 LoginMember

**路徑**: `com.sdm.entity.LoginMember`

**職責**: 登入會員資訊類別，儲存在Session中。

```java
public class LoginMember implements Serializable {

    private BigDecimal soMemberId;
    private String soMemberNo;
    private String soMemberName;
    private BigDecimal soStoreId;
    private String soStoreName;
    private BigDecimal defaultLanguageId;
    private String defaultDateType;
    private BigDecimal customerId;
    private String customerNo;
    private String customerName;

    // ... getter/setter
}
```

**說明**:
- 不對應資料庫表
- 儲存在HttpSession中
- 包含登入會員的基本資訊

---

### 4.4 RespBean

**路徑**: `com.sdm.entity.RespBean`

**職責**: 統一響應格式類別。

```java
public class RespBean {

    private boolean success;
    private String message;
    private Object data;

    public static RespBean success(String message) {
        return new RespBean(true, message, null);
    }

    public static RespBean success(String message, Object data) {
        return new RespBean(true, message, data);
    }

    public static RespBean error(String message) {
        return new RespBean(false, message, null);
    }

    // ... getter/setter
}
```

---

## 5. Utility層

### 5.1 EncryptionUtil

**路徑**: `com.sdm.utility.EncryptionUtil`

**職責**: 提供加密解密功能。

#### 5.1.1 主要方法

##### encrypt()
```java
public static String encrypt(String plainText)
```

**功能**: 加密字串

**演算法**: MD5 或 SHA-256

**參數**:
- `plainText`: 明文

**返回**: 密文

##### decrypt()
```java
public static String decrypt(String cipherText)
```

**功能**: 解密字串 (如果使用可逆加密)

**參數**:
- `cipherText`: 密文

**返回**: 明文

---

### 5.2 DateUtil

**路徑**: `com.sdm.utility.DateUtil`

**職責**: 提供日期處理功能。

#### 5.2.1 主要方法

##### formatDate()
```java
public static String formatDate(Date date, String pattern)
```

**功能**: 格式化日期

**參數**:
- `date`: 日期物件
- `pattern`: 格式模式 (如 "yyyy-MM-dd")

**返回**: 格式化後的日期字串

##### parseDate()
```java
public static Date parseDate(String dateStr, String pattern)
```

**功能**: 解析日期字串

**參數**:
- `dateStr`: 日期字串
- `pattern`: 格式模式

**返回**: Date物件

---

### 5.3 ConvertUtility

**路徑**: `com.sdm.utility.ConvertUtility`

**職責**: 提供資料轉換功能。

#### 5.3.1 主要方法

##### toBigDecimal()
```java
public static BigDecimal toBigDecimal(Object obj)
```

**功能**: 轉換為BigDecimal

##### toString()
```java
public static String toString(Object obj)
```

**功能**: 轉換為String

---

## 6. Filter層

### 6.1 A3Filter

**路徑**: `com.sdm.filter.A3Filter`

**職責**: 請求過濾器，處理登入驗證和權限控制。

#### 6.1.1 doFilter()

```java
@Override
public void doFilter(
    ServletRequest req,
    ServletResponse res,
    FilterChain chain
) throws IOException, ServletException
```

**功能**: 過濾HTTP請求

**流程**:
1. 檢查是否為靜態資源請求
2. 檢查是否為登入相關請求
3. 檢查Session中是否有LoginMember
4. 檢查是否在系統維護時間
5. 根據檢查結果決定放行或重定向

**放行條件**:
- 靜態資源 (CSS, JS, 圖片等)
- 登入相關請求 (/login, /loginCheck)
- 已登入用戶 (Session中有LoginMember)

**重定向條件**:
- 未登入用戶 -> 重定向到登入頁
- 系統維護時間 -> 重定向到維護頁

---

## 7. Configuration層

### 7.1 CaptchaConfig

**路徑**: `com.sdm.config.CaptchaConfig`

**職責**: 配置驗證碼生成器。

```java
@Configuration
public class CaptchaConfig {

    @Bean
    public Producer captchaProducer() {
        Properties properties = new Properties();
        properties.setProperty("kaptcha.image.width", "150");
        properties.setProperty("kaptcha.image.height", "50");
        properties.setProperty("kaptcha.textproducer.char.length", "4");

        Config config = new Config(properties);
        DefaultKaptcha captchaProducer = new DefaultKaptcha();
        captchaProducer.setConfig(config);

        return captchaProducer;
    }
}
```

**配置項**:
- 圖片寬度: 150px
- 圖片高度: 50px
- 驗證碼長度: 4位

---

### 7.2 FilterConfig

**路徑**: `com.sdm.config.FilterConfig`

**職責**: 配置過濾器。

```java
@Configuration
public class FilterConfig {

    @Bean
    public FilterRegistrationBean<A3Filter> a3Filter() {
        FilterRegistrationBean<A3Filter> registrationBean =
            new FilterRegistrationBean<>();

        registrationBean.setFilter(new A3Filter());
        registrationBean.addUrlPatterns("/*");
        registrationBean.setOrder(1);

        return registrationBean;
    }
}
```

**配置項**:
- 過濾器: A3Filter
- URL模式: /*
- 執行順序: 1

---

## 8. 附錄

### 8.1 常用存儲過程

#### 8.1.1 會員登入驗證
```sql
PROCEDURE LOGIN_CHECK(
    P_MEMBER_NO IN VARCHAR2,
    P_PASSWORD IN VARCHAR2,
    P_RESULT OUT NUMBER,
    P_MEMBER_INFO OUT SYS_REFCURSOR
)
```

#### 8.1.2 加入購物車
```sql
PROCEDURE ADD_TO_CART(
    P_MEMBER_ID IN NUMBER,
    P_ITEM_ID IN NUMBER,
    P_PART_ID IN NUMBER,
    P_QTY IN NUMBER,
    P_RESULT OUT NUMBER
)
```

#### 8.1.3 建立訂單
```sql
PROCEDURE CREATE_ORDER(
    P_MEMBER_ID IN NUMBER,
    P_ORDER_ID OUT NUMBER,
    P_ORDER_NO OUT VARCHAR2,
    P_RESULT OUT NUMBER
)
```

### 8.2 錯誤代碼

| 代碼 | 說明 |
|------|------|
| 0 | 成功 |
| -1 | 一般錯誤 |
| -2 | 參數錯誤 |
| -3 | 資料不存在 |
| -4 | 權限不足 |
| -5 | 資料重複 |

---

**文件結束**
